---
import type { Article } from '@domain'
import Segment from '../Segment.astro'
import Button from '../Button.astro'
import Modal from '../Modal.astro'
import Divider from '@components/Divider.astro'
import { match } from 'shulk'
import AddSectionForm from './AddSectionForm.astro'
interface Props {
	article: Article
}

const { article } = Astro.props
---

<div
	id="ShowArticle"
	x-data="{ generating: false, isAddSectionUrlOpen: false }"
>
	<Segment>
		<h1 style="margin-top: 0;">{article.title}</h1>

		{
			match(article).case({
				Pending: () => (
					<Button
						primary
						icon={'text_select_move_forward_character'}
						hx-patch={'/articles/' + article.slug + '/generate'}
						hx-target="#ShowArticle"
						loadOnClick
					>
						Generate
					</Button>
				),
				Generated: () => (
					<>
						<Button
							primary
							icon={'add'}
							x-on:click="isAddSectionUrlOpen = true"
						>
							Add a section (URL)
						</Button>
						<Button
							primary
							icon={'picture_as_pdf'}
							x-on:click="isAddSectionPdfOpen = true"
						>
							Add a section (PDF)
						</Button>
					</>
				),
			})
		}

		<Divider />

		<Modal title="Add a section" open="isAddSectionUrlOpen">
			<AddSectionForm articleSlug={article.slug} />
		</Modal>

		{
			article._state === 'Generated' && (
				<div>
					<section>
						{article.description.content.split('\n').map((part) => (
							<p>{part}</p>
						))}
					</section>

					{article.sections.map((section) => (
						<section>
							<h2>{section.title}</h2>
							<p>
								{section.content.split('\n').map((part) => (
									<p>{part}</p>
								))}
							</p>

							<h3>Sources</h3>
							{section._state === 'Sourced' &&
								section.sources.map((source, i) => (
									<p>
										[{i + 1}]{' '}
										<a href={source.url} target="_blank">
											{source.title}
										</a>
									</p>
								))}
						</section>
					))}

					<h2>Related to</h2>

					{article.relatedTo.map((art) => (
						<a
							href={'/articles/' + art.slug}
							style="text-decoration: none;"
						>
							<Button>{art.title}</Button>
						</a>
					))}
				</div>
			)
		}
	</Segment>
</div>
